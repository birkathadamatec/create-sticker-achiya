<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate PDF (Client) → Send Base64 to Webhook</title>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      /* תצוגה של המדבקה */
      --size: 3.98in;

      --border-outer: 2px;
      --border-inner: 1.5px;
      --ink: #111;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:18px;
      background:#f4f4f4;
      font-family: Arial, "Noto Sans Hebrew", sans-serif;
      color:#000;
    }

    .wrap{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap:16px;
      flex-wrap: wrap;
    }

    #label{
      width:var(--size);
      height:var(--size);
      background:#fff;
      border:var(--border-outer) solid var(--ink);
      display:grid;
      grid-template-rows: 0.498fr 0.376fr 0.126fr;
    }

    .top{
      display:grid;
      grid-template-columns: 0.339fr 0.661fr;
      border-bottom:var(--border-inner) solid var(--ink);
      min-height:0;
    }

    .top-left{
      display:grid;
      grid-template-rows: 0.492fr 0.508fr;
      border-left:var(--border-inner) solid var(--ink);
      min-height:0;
    }

    .cell{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:10mm 6mm;
      text-align:center;
      gap:6mm;
      min-height:0;
    }

    .cell + .cell{
      border-top:var(--border-inner) solid var(--ink);
    }

    .logo-cell{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:6mm;
      min-height:0;
    }
    .logo-cell img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      display:block;
    }

    .mid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      border-bottom:var(--border-inner) solid var(--ink);
      min-height:0;
    }
    .mid .cell:first-child{ border-left:var(--border-inner) solid var(--ink); }

    .bottom{
      display:grid;
      grid-template-columns: 1fr 1fr;
      min-height:0;
    }
    .bottom .cell:first-child{ border-left:var(--border-inner) solid var(--ink); }

    .t-small{ font-size: clamp(10px, 2.1vw, 16px); font-weight:500; }
    .t-med  { font-size: clamp(12px, 3.0vw, 20px); font-weight:500; }
    .t-big  { font-size: clamp(22px, 5.0vw, 38px); font-weight:500; }

    .panel{
      background:#fff;
      border:1px solid #ddd;
      border-radius:10px;
      padding:12px;
      min-width: 320px;
      max-width: 520px;
    }
    .panel h3{ margin:0 0 10px; font-size:16px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .grid label{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      color:#333;
    }
    input{
      padding:8px 10px;
      font-size:14px;
      border:1px solid #ccc;
      border-radius:8px;
      width:100%;
    }
    .controls{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    button{
      padding:10px 14px;
      font-size:14px;
      cursor:pointer;
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius:10px;
    }
    button.secondary{ background:#fff; color:#111; }
    .status{ margin-top:10px; font-size:13px; white-space:pre-wrap; }
    .hint{ margin-top:8px; font-size:12px; color:#444; line-height:1.4; }
  </style>
</head>

<body>
  <div class="wrap">

    <div id="label">
      <div class="top">
        <div class="top-left">
          <div class="cell task">
            <div class="t-small">מספר משימה</div>
            <div class="t-med" id="vTask">22154001</div>
          </div>

          <div class="cell">
            <div class="t-med" style="font-size:clamp(18px,4.5vw,30px); font-weight:600;" id="vType">ארגז</div>
            <div class="t-big" id="vBox">3/3</div>
          </div>
        </div>

        <div class="logo-cell">
          <img id="logoImg" alt="לוגו" src="logo.png" />
        </div>
      </div>

      <div class="mid">
        <div class="cell">
          <div class="t-med">טלפון לקוח:</div>
          <div class="t-med" id="vPhone">0502262235</div>
        </div>

        <div class="cell">
          <div class="t-med">כתובת:</div>
          <div class="t-med" id="vStreet">האורן 8</div>
          <div class="t-med" id="vCity">ירושלים</div>
        </div>
      </div>

      <div class="bottom">
        <div class="cell" style="padding:6mm;">
          <div class="t-big" id="vNum">7</div>
        </div>
        <div class="cell" style="padding:6mm;">
          <div class="t-big" id="vName">יוסף</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>עריכת המדבקה</h3>

      <div class="grid">
        <label>מספר משימה <input id="iTask" value="22154001" /></label>
        <label>סוג (ארגז/שקית) <input id="iType" value="ארגז" /></label>
        <label>ארגז (3/3) <input id="iBox" value="3/3" /></label>
        <label>טלפון לקוח <input id="iPhone" value="0502262235" /></label>
        <label>רחוב + מספר <input id="iStreet" value="האורן 8" /></label>
        <label>עיר <input id="iCity" value="ירושלים" /></label>
        <label>מספר גדול (שמאל למטה) <input id="iNum" value="7" /></label>
        <label>שם גדול (ימין למטה) <input id="iName" value="יוסף" /></label>
      </div>

      <div class="hint">
        אם עדיין “נשאר בפנים”: תגדיל <b>EXTRA_FEED_INCH</b> ל-0.55. אם מוציא יותר מדי – תוריד ל-0.30.
      </div>

      <div class="controls">
        <button id="btnSend">צור PDF ושלח לוובהוק</button>
        <button id="btnDownload" class="secondary" type="button">צור PDF והורד</button>
      </div>

      <div class="status" id="status"></div>
    </div>

  </div>

  <script>
    const WEBHOOK_URL = "https://hook.integrator.boost.space/q78rwd42j34fi2nyhj5hguj6xlug3e5q";

    // ✅ המדבקה עצמה (כמו בקובץ שעובד)
    const LABEL_INCH = 3.98;

    // ✅ תוספת הזנה אחרי הדפסה (הטריק לפתור “נשאר בפנים”)
    const EXTRA_FEED_INCH = 0.45; // ≈ 11.43mm (תשחק 0.30–0.55)

    const INCH_TO_MM = 25.4;
    const LABEL_MM = LABEL_INCH * INCH_TO_MM;
    const EXTRA_FEED_MM = EXTRA_FEED_INCH * INCH_TO_MM;

    const LOGO_DATA_URI = ""; // "data:image/png;base64,..."

    function setStatus(msg){ document.getElementById("status").textContent = msg; }

    function applyLogo(){
      const img = document.getElementById("logoImg");
      if (LOGO_DATA_URI && LOGO_DATA_URI.startsWith("data:image/")) img.src = LOGO_DATA_URI;
    }

    function updateLabelFromInputs(){
      vTask.textContent   = iTask.value || "";
      vType.textContent   = iType.value || "";
      vBox.textContent    = iBox.value || "";
      vPhone.textContent  = iPhone.value || "";
      vStreet.textContent = iStreet.value || "";
      vCity.textContent   = iCity.value || "";
      vNum.textContent    = iNum.value || "";
      vName.textContent   = iName.value || "";
    }

    function safeSlug(s){
      return (s || "")
        .trim()
        .replace(/[^\w\u0590-\u05FF\- ]+/g, "")
        .replace(/\s+/g, "-")
        .slice(0, 50) || "label";
    }

    function waitForImages(el, timeoutMs = 4000){
      const imgs = Array.from(el.querySelectorAll("img"));
      if (imgs.length === 0) return Promise.resolve();
      return new Promise((resolve) => {
        const start = Date.now();
        const tick = () => {
          const done = imgs.every(im => im.complete && im.naturalWidth > 0);
          if (done) return resolve();
          if (Date.now() - start > timeoutMs) return resolve();
          setTimeout(tick, 60);
        };
        tick();
      });
    }

    async function generatePdfBase64FromElement(el){
      await waitForImages(el);

      const canvas = await html2canvas(el, {
        backgroundColor: "#ffffff",
        scale: 2,
        useCORS: true
      });

      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;

      // ✅ הדף גבוה יותר כדי לייצר “עוד הזנה”
      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: [LABEL_MM, LABEL_MM + EXTRA_FEED_MM]
      });

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      // ✅ המדבקה עצמה מודבקת למעלה בגודל המדויק
      pdf.addImage(imgData, "PNG", 0, 0, pageW, LABEL_MM);

      setStatus(
        "נוצר PDF:\n" +
        `• Label (inch): ${LABEL_INCH} × ${LABEL_INCH}\n` +
        `• Extra feed (inch): ${EXTRA_FEED_INCH}\n` +
        `• Page (mm): ${pageW.toFixed(3)} × ${pageH.toFixed(3)}\n` +
        `• Label area (mm): ${LABEL_MM.toFixed(3)} × ${LABEL_MM.toFixed(3)}\n` +
        `• Extra feed (mm): ${EXTRA_FEED_MM.toFixed(3)}\n` +
        "מחשב Base64..."
      );

      const dataUriString = pdf.output("datauristring");
      return dataUriString.split(",")[1];
    }

    async function sendPdfBase64ToWebhookNoCors(pdfBase64, fileName, meta){
      const payload = { fileName, mimeType: "application/pdf", pdfBase64, meta };

      await fetch(WEBHOOK_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: JSON.stringify(payload)
      });
    }

    function downloadBase64Pdf(pdfBase64, filename){
      const byteChars = atob(pdfBase64);
      const bytes = new Uint8Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) bytes[i] = byteChars.charCodeAt(i);
      const blob = new Blob([bytes], { type: "application/pdf" });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function collectMeta(){
      return {
        taskNumber: iTask.value,
        type: iType.value,
        box: iBox.value,
        phone: iPhone.value,
        street: iStreet.value,
        city: iCity.value,
        bigNumber: iNum.value,
        bigName: iName.value,
        labelInch: LABEL_INCH,
        extraFeedInch: EXTRA_FEED_INCH,
        generatedAt: new Date().toISOString()
      };
    }

    // init
    applyLogo();
    updateLabelFromInputs();

    ["iTask","iType","iBox","iPhone","iStreet","iCity","iNum","iName"].forEach(id=>{
      document.getElementById(id).addEventListener("input", updateLabelFromInputs);
    });

    btnSend.addEventListener("click", async () => {
      try{
        updateLabelFromInputs();
        setStatus("מייצר PDF...");

        const pdfBase64 = await generatePdfBase64FromElement(label);
        const fileName = `label-${safeSlug(iTask.value || "task")}.pdf`;

        setStatus(status.textContent + "\n\nשולח לוובהוק...\n" + `Base64 length: ${pdfBase64.length}`);
        await sendPdfBase64ToWebhookNoCors(pdfBase64, fileName, collectMeta());
        setStatus(status.textContent + "\n\nנשלח.");
      }catch(e){
        setStatus("שגיאה:\n" + (e?.message || e));
      }
    });

    btnDownload.addEventListener("click", async () => {
      try{
        updateLabelFromInputs();
        setStatus("מייצר PDF להורדה...");

        const pdfBase64 = await generatePdfBase64FromElement(label);
        const fileName = `label-${safeSlug(iTask.value || "task")}.pdf`;

        downloadBase64Pdf(pdfBase64, fileName);
        setStatus(status.textContent + `\n\nירד למחשב: ${fileName}`);
      }catch(e){
        setStatus("שגיאה:\n" + (e?.message || e));
      }
    });
  </script>
</body>
</html>
