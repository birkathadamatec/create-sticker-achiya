<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>חיפוש ברקוד → מדבקות</title>

  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --text:#eaf0ff;
      --muted:#a9b4d6;
      --accent:#6ea8ff;
      --accent2:#76f3c7;
      --danger:#ff6b6b;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 18px;
      --label-border: rgba(255,255,255,.18);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Hebrew", "Assistant", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 70% 0%, rgba(110,168,255,.25), transparent 60%),
        radial-gradient(900px 600px at 10% 30%, rgba(118,243,199,.18), transparent 55%),
        linear-gradient(180deg, #070a14, var(--bg));
      min-height:100vh;
    }

    .wrap{max-width: 980px; margin: 0 auto; padding: 28px 18px 60px;}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .brand .dot{
      width:14px;height:14px;border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 6px rgba(110,168,255,.12);
    }
    h1{margin:0; font-size: 18px; letter-spacing:.2px; font-weight: 750;}
    .sub{margin:0; color:var(--muted); font-size: 13px; margin-top:2px;}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:stretch;}

    .inputWrap{flex: 1 1 380px; position:relative;}
    input[type="text"]{
      width:100%;
      padding: 14px 14px 14px 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,14,28,.55);
      color: var(--text);
      outline: none;
      font-size: 16px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    input[type="text"]::placeholder{color: rgba(233,240,255,.55)}
    input[type="text"]:focus{border-color: rgba(110,168,255,.55); box-shadow: 0 0 0 6px rgba(110,168,255,.16);}

    .scanIcon{
      position:absolute; left: 12px; top:50%;
      transform: translateY(-50%);
      width: 22px; height: 22px;
      opacity:.9; pointer-events:none;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
    }

    button{
      border:0; border-radius: 14px;
      padding: 14px 16px;
      font-size: 15px; font-weight: 700;
      cursor:pointer;
      transition: transform .08s ease, filter .15s ease, opacity .2s ease;
      user-select:none; white-space:nowrap;
    }
    button:active{transform: translateY(1px)}
    .btnPrimary{
      background: linear-gradient(135deg, var(--accent), #8d7bff);
      color: #081022;
      box-shadow: 0 14px 30px rgba(110,168,255,.22);
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
    }
    .btnPrimary[disabled], .btnGhost[disabled]{opacity:.55; cursor:not-allowed}

    .status{
      margin-top: 12px;
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size: 13px;
      min-height: 20px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-weight: 650;
      font-size: 12px;
    }
    .spinner{
      width:14px;height:14px;border-radius:50%;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.85);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {to{transform:rotate(360deg)}}
    .error{color: #ffd6d6;}
    .error .pill{
      border-color: rgba(255,107,107,.45);
      background: rgba(255,107,107,.10);
      color: #ffd6d6;
    }

    .labelsWrap{margin-top: 16px; display:none;}
    .labelsHead{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 10px;}
    .labelsHead h2{margin:0; font-size: 15px; font-weight: 780;}
    .labelsGrid{display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;}

    .label{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--label-border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.28);
      position:relative;
      overflow:hidden;
      min-height: 190px;
    }
    .label::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(380px 220px at 80% 0%, rgba(110,168,255,.18), transparent 55%),
                  radial-gradient(320px 220px at 10% 100%, rgba(118,243,199,.14), transparent 55%);
      pointer-events:none;
      z-index:0;
    }
    .label > *{position:relative; z-index:1}

    .labelTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom: 10px;}
    .logoBox{display:flex; align-items:center; gap:10px; min-width:0;}
    .logoBox img{
      width: 54px; height: 54px; object-fit: contain;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      padding: 8px;
    }
    .labelMeta{text-align:left; display:flex; flex-direction:column; gap:6px; align-items:flex-end;}
    .counter{
      font-weight: 800;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }

    .kv{display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 8px;}
    .kvRow{
      background: rgba(10,14,28,.35);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .k{color: var(--muted); font-size: 12px; margin-bottom: 2px; font-weight: 650;}
    .v{
      font-size: 18px;
      font-weight: 850;
      letter-spacing: .3px;
      color: var(--text);
      word-break: break-word;
      line-height: 1.15;
    }
    .tinyNote{margin-top: 10px; color: rgba(233,240,255,.55); font-size: 12px;}

    @media print{
      body{background:#fff !important; color:#000 !important;}
      .wrap{max-width:none; padding:0; margin:0}
      header, .panel, .labelsHead, .status, .noPrint{display:none !important;}
      .labelsWrap{display:block !important; margin:0 !important;}
      .labelsGrid{grid-template-columns: 1fr !important; gap: 0 !important;}
      .label{
        page-break-after: always;
        border: 1px solid #000 !important;
        box-shadow:none !important;
        background:#fff !important;
        border-radius: 0 !important;
        min-height: auto !important;
      }
      .label::before{display:none !important;}
      .kvRow{border: 1px solid #000 !important; background:#fff !important;}
      .k{color:#000 !important}
      .v{color:#000 !important}
      .logoBox img{border: 1px solid #000 !important; background:#fff !important;}
      .counter{border: 1px solid #000 !important; background:#fff !important; color:#000 !important;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>חיפוש ברקוד והפקת מדבקות</h1>
          <p class="sub">סריקה → חיפוש אוטומטי | הקלדה ידנית → חיפוש בלחיצה</p>
        </div>
      </div>
      <div class="noPrint" style="display:flex; gap:10px; align-items:center;">
        <span class="pill" title="הקובץ image.png צריך להיות באותה תיקייה">image.png ✓</span>
      </div>
    </header>

    <div class="panel noPrint">
      <div class="row">
        <div class="inputWrap">
          <svg class="scanIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7V6a2 2 0 0 1 2-2h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M20 7V6a2 2 0 0 0-2-2h-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 17v1a2 2 0 0 0 2 2h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M20 17v1a2 2 0 0 1-2 2h-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M13 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M16 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>

          <input id="barcodeInput" type="text" inputmode="text" autocomplete="off"
                 placeholder="סרוק / הדבק ברקוד כאן…" />
        </div>

        <button id="searchBtn" class="btnPrimary">חיפוש</button>
        <button id="clearBtn" class="btnGhost">נקה</button>
      </div>

      <div id="status" class="status"></div>
    </div>

    <div id="labelsWrap" class="labelsWrap">
      <div class="labelsHead">
        <h2>תצוגת מדבקות</h2>
        <div class="noPrint" style="display:flex; gap:10px;">
          <button id="printBtn" class="btnPrimary">שלח להדפסה</button>
          <button id="backBtn" class="btnGhost">חזרה לחיפוש</button>
        </div>
      </div>

      <div id="labelsGrid" class="labelsGrid"></div>
    </div>
  </div>

  <script>
    // === Config ===
    const WEBHOOK_URL = "https://hook.integrator.boost.space/36qda98lb8qyzgj53xuqnsi8igbugnxr";

    // דרישה: אם אין 201 עם נתונים תוך 2 שניות => שגיאה
    const POLL_TIMEOUT_MS  = 2000;

    // כדי להספיק בתוך 2 שניות, פולינג מהיר יחסית
    const POLL_INTERVAL_MS = 250;

    // זיהוי "סריקה" מול "הקלדה ידנית"
    // רוב הסורקים מזינים את כל המחרוזת מהר מאוד (עשרות מילישניות לכל התו),
    // בעוד הקלדה ידנית איטית בהרבה.
    const SCAN_MAX_TOTAL_MS = 220;   // כל הקלט הושלם מהר מזה => סריקה
    const SCAN_MIN_LEN      = 4;     // כדי לא לטריגר על הקלדה של 1-2 תווים

    // === Elements ===
    const barcodeInput = document.getElementById("barcodeInput");
    const searchBtn    = document.getElementById("searchBtn");
    const clearBtn     = document.getElementById("clearBtn");
    const statusEl     = document.getElementById("status");

    const labelsWrap   = document.getElementById("labelsWrap");
    const labelsGrid   = document.getElementById("labelsGrid");
    const printBtn     = document.getElementById("printBtn");
    const backBtn      = document.getElementById("backBtn");

    let activeAbortController = null;

    // state for scan detection
    let firstKeyTime = null;
    let lastKeyTime = null;
    let keyCount = 0;

    function setStatus(text, {loading=false, error=false} = {}){
      statusEl.className = "status" + (error ? " error" : "");
      if(!text){
        statusEl.innerHTML = "";
        return;
      }
      const pill = loading
        ? `<span class="pill"><span class="spinner" aria-hidden="true"></span> ${escapeHtml(text)}</span>`
        : `<span class="pill">${escapeHtml(text)}</span>`;
      statusEl.innerHTML = pill;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showLabelsView(){
      labelsWrap.style.display = "block";
      document.querySelectorAll(".panel, header").forEach(el => el.style.display = "none");
      window.scrollTo({top: 0, behavior: "smooth"});
    }

    function showSearchView(){
      labelsWrap.style.display = "none";
      document.querySelectorAll(".panel, header").forEach(el => el.style.display = "");
      labelsGrid.innerHTML = "";
      setStatus("");
      barcodeInput.focus();
    }

    function buildLabels({ barcode, wp_order_id, driver_str, packages_quantity }){
      const total = Number(packages_quantity || 1);
      const count = (Number.isFinite(total) && total > 1) ? total : 1;

      labelsGrid.innerHTML = "";

      for(let i=1; i<=count; i++){
        const counter = count > 1 ? `${i}/${count}` : "";
        const label = document.createElement("div");
        label.className = "label";

        label.innerHTML = `
          <div class="labelTop">
            <div class="logoBox">
              <img src="image.png" alt="לוגו" onerror="this.style.display='none'">
            </div>
            <div class="labelMeta">
              ${counter ? `<div class="counter">${escapeHtml(counter)}</div>` : ""}
            </div>
          </div>

          <div class="kv">
            <div class="kvRow">
              <div class="k">מספר הזמנה</div>
              <div class="v">${escapeHtml(wp_order_id ?? "")}</div>
            </div>

            <div class="kvRow">
              <div class="k">שם הנהג</div>
              <div class="v">${escapeHtml(driver_str ?? "")}</div>
            </div>

            <div class="kvRow">
              <div class="k">מספר משימה</div>
              <div class="v">${escapeHtml(barcode)}</div>
            </div>
          </div>

          <div class="tinyNote">הדפסה: בדוק הגדרות מדפסת מדבקות (גודל, שוליים, קנה מידה).</div>
        `;
        labelsGrid.appendChild(label);
      }
    }

    async function safeReadText(res){
      try { return (await res.text())?.slice(0, 200); } catch { return ""; }
    }

    async function postAndMaybeGetData(barcode, signal){
      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ barcode }),
        signal
      });

      if(res.status === 201){
        const data = await res.json();
        return { done: true, data };
      }

      if(res.status === 200){
        return { done: false, data: null };
      }

      const txt = await safeReadText(res);
      throw new Error(`שגיאה מהשרת: ${res.status}${txt ? " - " + txt : ""}`);
    }

    async function runSearch(){
      const barcode = (barcodeInput.value || "").trim();
      if(!barcode){
        setStatus("חסר ברקוד", {error:true});
        barcodeInput.focus();
        return;
      }

      // Cancel previous
      if(activeAbortController){
        activeAbortController.abort();
      }
      activeAbortController = new AbortController();

      searchBtn.disabled = true;
      clearBtn.disabled = true;

      const startedAt = Date.now();
      setStatus("נשלח... ממתין לסטטוס 201", {loading:true});

      try{
        // First attempt
        let result = await postAndMaybeGetData(barcode, activeAbortController.signal);

        // Poll quickly until we get 201 or timeout at 2 seconds total
        while(!result.done){
          if(Date.now() - startedAt >= POLL_TIMEOUT_MS){
            throw new Error("לא התקבל סטטוס 201 עם נתונים תוך 2 שניות.");
          }
          await new Promise(r => setTimeout(r, POLL_INTERVAL_MS));
          result = await postAndMaybeGetData(barcode, activeAbortController.signal);
        }

        const payload = result.data || {};
        buildLabels({
          barcode,
          wp_order_id: payload.wp_order_id ?? "",
          driver_str: payload.driver_str ?? "",
          packages_quantity: payload.packages_quantity ?? 1
        });

        setStatus("");
        showLabelsView();

      }catch(err){
        if(err?.name === "AbortError") return;
        setStatus(err?.message || "שגיאה לא ידועה", {error:true});
      }finally{
        searchBtn.disabled = false;
        clearBtn.disabled = false;
      }
    }

    // === Scan detection ===
    function resetTypingProfile(){
      firstKeyTime = null;
      lastKeyTime = null;
      keyCount = 0;
    }

    function isLikelyScan(){
      const v = (barcodeInput.value || "").trim();
      if(v.length < SCAN_MIN_LEN) return false;
      if(firstKeyTime == null || lastKeyTime == null) return false;
      const total = lastKeyTime - firstKeyTime;
      return total > 0 && total <= SCAN_MAX_TOTAL_MS;
    }

    // === Events ===
    searchBtn.addEventListener("click", runSearch);

    clearBtn.addEventListener("click", () => {
      barcodeInput.value = "";
      resetTypingProfile();
      setStatus("");
      barcodeInput.focus();
    });

    backBtn.addEventListener("click", () => showSearchView());

    // נשאר ריק כרגע כמו שביקשת
    printBtn.addEventListener("click", () => {
      // intentionally empty placeholder
      // later: window.print();
    });

    // נבנה פרופיל הקלדה/סריקה לפי keydown (כדי להבדיל מהדבקה/אוטופיל)
    barcodeInput.addEventListener("keydown", (e) => {
      const now = performance.now();

      // אם זה התו הראשון בסשן
      if(firstKeyTime == null) firstKeyTime = now;
      lastKeyTime = now;

      // נספור רק תווים "אמיתיים"
      if(e.key && e.key.length === 1) keyCount++;

      // הרבה סורקים שולחים Enter בסוף -> במקרה כזה נריץ רק אם זו סריקה
      if(e.key === "Enter"){
        e.preventDefault();
        const shouldAutoRun = isLikelyScan();
        resetTypingProfile();

        if(shouldAutoRun){
          runSearch();
        }else{
          // הקלדה ידנית: Enter לא מריץ. רק כפתור חיפוש.
          setStatus("הוקלד ידנית — לחץ על חיפוש", {loading:false});
        }
      }
    });

    // אם המשתמש מקליד לאט (ידני) – לא מריצים כלום.
    // אם זו סריקה בלי Enter (נדיר, אבל קיים) – נריץ אחרי blur/Change רק אם זה נראה סריקה.
    barcodeInput.addEventListener("change", () => {
      if(isLikelyScan()){
        runSearch();
      }
      resetTypingProfile();
    });

    // Focus on load
    window.addEventListener("load", () => barcodeInput.focus());
  </script>
</body>
</html>
